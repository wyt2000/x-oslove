# 调研报告

**OSLOVE**

## 目录

[TOC]

## 小组成员

- 吴钰同（PB18111684）
- 黄炜喆（PB18111765）
- 李钰铭（PB18111771）
- 明宇龙（PB18111710）

## 项目简介

使用TypeScript实现基于CRDT的LaTeX实时协作编辑系统，编写成符合LSP协议的插件，并使之能在vscode等IDE上使用。

## 项目背景

### LaTex

#### 简介

**LaTeX**（/ˈlɑːtɛx/，常被读作/ˈlɑːtɛk/或/ˈleɪtɛk/，写作“LATEX”），是一种基于TeX的排版系统，由美国计算机科学家莱斯利·兰伯特在20世纪80年代初期开发，利用这种格式系统的处理，即使用户没有排版和程序设计的知识也可以充分发挥由TeX所提供的强大功能，不必一一亲自去设计或校对，能在几天，甚至几小时内生成很多具有书籍质量的印刷品。

#### 设计思路

LaTeX遵循呈现与内容分离的设计理念，以便作者可以专注于他们正在编写的内容，而不必同时注视其外观，将文档排版交由文档设计者实现。在准备LaTeX文档时，作者使用章（chapter）、节（section）、表（table）、图（figure）等简单的概念指定文档的逻辑结构，并让LaTeX系统负责这些结构的格式和布局。因此，它鼓励从内容中分离布局，同时仍然允许在需要时进行手动排版调整。这个概念类似于许多文字处理器允许全局定义整个文档的样式的机制，或使用层叠样式表来规定HTML的样式。LaTeX系统是一种可以处理排版和渲染的标记语言。

#### 特性与功能

- 排版期刊文章，技术报告，书籍和幻灯片演示。
- 控制包含节，交叉引用，表格和图形的大型文档。
- 复杂数学公式的排版。
- 使用AMS-LaTeX进行数学的高级排版。
- 自动生成书目和索引。
- 支持多语言排版。
- 包含艺术品，以及印刷或专色。
- 使用PostScript或Metafont字体。
- 各种各样的宏包，拓展了LaTex的功能
- 模板质量高，管理的格式多

### 现有的LaTex实时协作编辑系统

#### Overleaf

Overleaf是一个在线多人实时协作LaTex编辑平台，支持在线创建和管理LaTex项目以及实时预览，同时可以导出源代码或PDF文档。

它的优点：

- 不用安装和配置，打开网站即可编辑。
- 预设了各种package，不用在本地安装。
- 多人协作。
- 版本控制。
- 自动补全。

它的缺点：

- 实时预览速度较慢。
- 免费账户只能支持两个人的协作，即使是付费账户，最多也只能支持10个人的协作。

![1584748386325](pics/1584748386325.png)

![1584750200438](pics/1584750200438.png)

#### 其他LaTex实时协作编辑系统

- Authorea
- Auto-Latex Equations for Google Docs
- PaperHive

###  传统的实时协作插件

（待补充

## 立项依据

### TypeScript

#### TypeScript简介

TypeScript 是 Microsoft 开发和维护的一种面向对象的编程语言。它是 JavaScript 的超集，包含了 JavaScript 的所有元素，可以载入 JavaScript 代码运行，并扩展了 JavaScript 的语法，所以任何现有的JavaScript程序可以运行在在TypeScript环境中，TypeScript会编译为JavaScript，而且本质上向这个语言添加了可选的静态类型和基于类的面向对象编程TypeScript 支持为已存在的 JavaScript 库添加类型信息的头文件，扩展了它对于流行的库如jQuery，Node.js和 D3.js 的好处。

#### TypeScript与Javascript的对比

TypeScript是静态类型，js是动态类型。静态类型检查可以做到early fail，即你编写的代码即使没有被执行到，一旦你编写代码时发生类型不匹配，语言在编译阶段（解释执行也一样，可以在运行前）即可发现，同时IDE也能提供大量便捷支持。对小型项目而言也许发挥不出多大优势，然而当项目规模膨胀，运行前的类型检查就大放异彩了——首先，大型项目测试调试分支覆盖困难，很多代码并不一定能够在所有条件下执行到，运行前的类型检查是减少bug的一大手段；其次，静态类型对阅读代码是友好的，在团队合作、代码维护和交接中意义不言自明；最后，IDE提供的大量便捷支持和TS本身的语法检查和代码提示自动补全让开发者提高效率，方便重构。当然，TypeScript 只是为 JavaScript 中本身就存在的使用方式提供了对应的类型标注，所有在 TypeScript 中能够使用的开发模式，在 JavaScript 中一定是本身就存在的。

TypeScript 可以使用 JavaScript 中的所有代码和编码概念，TypeScript 是为了使 JavaScript 的开发变得更加容易而创建的。例如，TypeScript 使用类型和接口等概念来描述正在使用的数据，这使开发人员能够快速检测错误并调试应用程序，TypeScript 从核心语言方面和类概念的模塑方面对 JavaScript 对象模型进行扩展。JavaScript 代码可以在无需任何修改的情况下与 TypeScript 一同工作，同时可以使用编译器将 TypeScript 代码转换为 JavaScript。

下面列举 TypeScript 相比于 JavaScript 的显著优势：

- 静态输入

静态类型化是一种功能，可以在开发人员编写脚本时检测错误。查找并修复错误是当今开发团队的迫切需求。有了这项功能，就会允许开发人员编写更健壮的代码并对其进行维护，以便使得代码质量更好、更清晰。

- 大型的开发项目

有时为了改进开发项目，需要对代码库进行小的增量更改。这些小小的变化可能会产生严重的、意想不到的后果，因此有必要撤销这些变化。使用TypeScript工具来进行重构更变的容易、快捷。

- 更好的协作

当发开大型项目时，会有许多开发人员，此时乱码和错误的机也会增加。类型安全是一种在编码期间检测错误的功能，而不是在编译项目时检测错误。这为开发团队创建了一个更高效的编码和调试过程。

- 更强的生产力

干净的 ECMAScript 6 代码，自动完成和动态输入等因素有助于提高开发人员的工作效率。这些功能也有助于编译器创建优化的代码。

### Language-Server-Protocol

（待补充

### CRDT

#### CRDT简介

**CRDT是Conflict-Free Replicated Data Types的缩写**，直译的话即“无冲突可复制数据类型”。研究分布式系统，尤其是研究最终一致性分布式系统的过程中，一个最基本的问题就是，应该采用什么样的数据结构来保证最终一致性。CRDT即是理论界目前对于这个问题的答案。CRDT是各种基础数据结构最终一致算法的理论总结，能根据一定的规则自动合并，解决冲突，达到强最终一致的效果。CAP定理告诉我们，在构建分布式系统的时候，Consistency（一致性），Availability（可用性），Partition tolerance（分区容错性），这三者只可以同时选择两样。最终一致性的系统不是不保证一致性，而是不在保证可用性和分区容错性的同时保证一致性。最终我们还是要在最终一致性的各节点之间处理数据，使他们达到一致。

先简单统一一下概念和名词:

- object: 可以理解为“副本”
- operation: 操作接口，由客户端调用，分为两种，读操作query和写操作update
- query: 查询操作，仅查询本地副本
- update: 更新操作，先尝试进行本地副本更新，若更新成功则将本地更新同步至远端副本
- merge: update在远端副本的合并操作

一个数据结构符合CRDT的条件是update操作和merge操作需满足交换律、结合律和幂等律，具体证明见[2]，在此不做赘述。如果update操作本身满足以上三律，merge操作仅需要对update操作进行回放即可，这种形式称为**op-based CRDT**，最简单的例子是集合求并集。

![1584752317755](pics/1584752317755.png)

![1584752367117](pics/1584752367117.png)

如果update操作无法满足条件，则可以考虑同步副本数据，同时附带额外元信息，通过元信息让update和merge操作具备以上三律，这种形式称为**state-based CRDT**。让元信息满足条件的方式是让其更新保持“单调”，这个关系一般被称为“偏序关系”。举一个简单例子，每次update操作都带上时间戳，在merge时对本地副本时间戳及同步副本时间戳进行比对，取更新的结果，这样总能保证结果最新并且最终一致，这种方式称为Last Write Wins。

![1584752530408](pics\1584752530408.png)

![1584752493000](C:\Users\doujihu\AppData\Roaming\Typora\typora-user-images\1584752493000.png)

#### 参考18年项目的CRDT的不足

1.仅实现了对单个字符的操作，效率很低，而且当面对大量用户编辑或者文档量很大时每个字符的标识符可能会非常长，这样会对内存和运行效率带来很大的影响。

2.为了保证每个客户端不会生成一个已经被使用的位置标识符，需要客户端维持记录保证不会产生使用过的标识符，当编辑时间较长文档量较大时对客户端内存也将带来较大负担。

3.在本地进行编辑时，进行复制删除等操作时有时会出错，对一些细节上的处理存在逻辑漏洞，导致不太好的用户体验。

### String-wise CRDT and Selective Undo

一个实时文本协作系统应该至少支持普通文本编辑器的最基本的功能，包括：**对单个字符的插入和删除**，**对字符串的插入和删除**，以及**对插入和删除的撤销和重做**。其中，基于字符串的操作是许多其他操作的基础，如复制粘贴，选择删除和查找替换；撤销操作的实现很复杂，因为一个客户端不止可以撤销自己的操作，也可以撤销其他客户端的操作。较早的实时文本协作算法不能很好地支持基于字符串的操作，它们的不足如下：

#### OT(Operational Transformation)

为了解决多个客户端同时发出请求产生的冲突，服务器保存所有操作的历史，并把客户端的操作按照一定的规则排序，将排序靠后的操作进行变换使之相容，然后按照此顺序对文本进行更改。

例如：对于s=”abc“这样的字符串，一个用户s[1]='b'之前插入’d‘，此操作记作ins(1,'a')，另一个用户并发地删除s[2]='c'，此操作记作del(2)。OT算法必须能够将del(2)变换成del(3)，以确保删除的是正确的字符。

由于OT算法固有的复杂性，目前很少有OT算法支持基于字符串的操作，例如：两个客户端同时对字符串的同一位置进行粘贴和删除，会使变换算法变得非常复杂，而且容易被举出反例。

#### CRDT(Conflict-Free Replicated Data Types)

CRDT通过数据结构的序关系而非操作变换来处理并发请求，避开了复杂的变换算法。可以通俗地理解为，CRDT为每个字符设计了一个唯一且不变的标识符（如上文所述，这个标识符可以是时间，也可以是某个字符在文档中的相对位置），通过标识符可以唯一确定客户操作的字符，当遇到上述冲突时，实际删除的字符永远是按照标识符来索引的，不会因为前面的字符的插入而改变。

但是，对于字符串的操作，标识符的设计会变得很复杂，而且由于没有保存操作历史，撤销操作无从实现。

#### Merging the two Methods

于是有人[1]提出将OT和CRDT两种方法结合，从而实现基于字符串的操作和撤销。他的数据结构如下：每个客户端有一个view，一个model，一个日志和3个队列，其中view就是当前的字符串，一个用户可以在该字符串的任意位置插入或删除一个子串，以及撤销日志中的任意一个本地或远程的历史操作。本地的操作和来自其他用户的操作首先保存在队列Qv和Qin中，再通过model进行整合，整合后的本地操作首先存在队列Qout中，之后广播给其他客户端。当model渲染完毕，本地和远程操作的整合将会展示在view中，同时保存在日志里。

![1584716595276](pics\1584716595276.png)

所谓的model实际上是双向链表和邻接表。双向链表用来保存每一次操作的子串以及额外的标识信息，它们以一定的顺序相连。每一种操作占一张邻接表，用来保存每次这种操作所涉及的所有结点。下图便是一个例子，用黑色实线表示实际字符串的相邻，虚线表示同一次插入操作插入的结点，灰色实线表示同一次删除操作删除的结点，结点下面的黑点是结点被删除的标记，而灰点表示此次删除被撤销了，当遇到插入或删除操作时，先分裂结点，再修改标记和邻接表。注意到，撤销D1操作不会将B还原，因为B被并发地删除了两次(D1,D2)。

![1584716630887](C:\Users\doujihu\AppData\Roaming\Typora\typora-user-images\1584716630887.png)

（待补充

## 重要性与前瞻性分析

- **着眼Latex**

  LaTeX是当今世界上最流行和使用最为广泛的TeX格式。Latex拥有强大功能，从而使用者可以在短短的时间内生成高质量的文档。对于生成复杂的数学公式，LaTeX表现的更为出色。其在排版界的重要性不言而喻。

- **使用CRDT**

  CRDT是各种基础数据结构最终一致算法的理论总结，能根据一定的规则自动合并，解决冲突，达到强最终一致的效果。相较于传统OT算法，CRDT更为稳定，可维护性更强。对比之前同学的工作，本项目以字符串为最小单位的CRDT，对复制、粘贴等操作具有更好的支持。

- **利用LSP**

  LSP是一种用于IDE与语言服务器之间的一种协议，支持语言插件在不同IDE上使用。相较于浏览器，本项目更加尊重用户习惯；而对比传统语言插件，由于可跨IDE，本项目实用性更强，推广速度更快。

## 相关工作

（待补充

## 参考文献

[1]https://github.com/OSH-2018/X-wyj-1

[2]https://en.wikipedia.org/wiki/Comparison_of_TeX_editors

[3]www.overleaf.com

[4]Marc Shapiro, Nuno Preguiça, Carlos Baquero, Marek Zawirski. Conflict-free Replicated Data Types.[Research Report] RR-7687, INRIA. 2011, pp.18. ffinria-00609399v2f 

[5]Marc Shapiro, Nuno Preguiça, Carlos Baquero, Marek Zawirski. A comprehensive study of Convergent and Commutative Replicated Data Types. [Research Report] RR-7506, Inria – Centre ParisRocquencourt;INRIA. 2011, pp.50. ffinria-00555588f 

[6]Yu Weihai. Supporting String-Wise Operations and Selective Undo for Peer-to-Peer Group Editing

（待补充